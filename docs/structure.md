# Arquitectura y Estructura del Proyecto

## üèóÔ∏è Panorama General
TradeUpSPY implementa una arquitectura modular basada en Domain-Driven Design (DDD), separando claramente las responsabilidades entre modelos de dominio, l√≥gica de negocio, integraciones externas e interfaces de usuario. Esta estructura garantiza mantenibilidad, testabilidad y escalabilidad del sistema.

## Organizaci√≥n de directorios

```
TradeUpSPY/
‚îú‚îÄ‚îÄ .env.example                    # Template de configuraci√≥n de entorno
‚îú‚îÄ‚îÄ .env                           # Variables de entorno locales (gitignored)
‚îú‚îÄ‚îÄ .gitignore                     # Patrones de exclusi√≥n de Git
‚îú‚îÄ‚îÄ README.md                      # Documentaci√≥n principal del proyecto
‚îú‚îÄ‚îÄ requirements.txt               # Dependencias de Python
‚îú‚îÄ‚îÄ fix_grados.py                  # Utilidad: correcci√≥n de grado del cat√°logo v√≠a CSFloat API
‚îÇ
‚îú‚îÄ‚îÄ contracts/                     # Archivos de definici√≥n de contratos
‚îÇ   ‚îú‚îÄ‚îÄ ejemplo_contrato.csv       # Contrato de ejemplo (Chroma + Prisma 2)
‚îÇ   ‚îî‚îÄ‚îÄ contrato_osiris_supernova.csv  # Ejemplo real de contrato
‚îÇ
‚îú‚îÄ‚îÄ data/                          # Datos de referencia est√°ticos
‚îÇ   ‚îú‚îÄ‚îÄ skins.csv                  # Cat√°logo maestro de skins (encabezados en espa√±ol)
‚îÇ   ‚îú‚îÄ‚îÄ skins_fixed.csv            # Cat√°logo corregido por API (generado)
‚îÇ   ‚îî‚îÄ‚îÄ rarity_cache.json          # Cach√© de respuestas de CSFloat API
‚îÇ
‚îú‚îÄ‚îÄ docs/                          # Documentaci√≥n completa
‚îÇ   ‚îú‚îÄ‚îÄ api_csfloat.md             # Gu√≠a de integraci√≥n con CSFloat API
‚îÇ   ‚îú‚îÄ‚îÄ guia_contratos.md          # Gu√≠a de trade-ups (espa√±ol)
‚îÇ   ‚îú‚îÄ‚îÄ product.md                 # Visi√≥n del producto y funcionalidades
‚îÇ   ‚îú‚îÄ‚îÄ structure.md               # Este archivo: arquitectura general
‚îÇ   ‚îî‚îÄ‚îÄ tech.md                    # Especificaciones t√©cnicas y stack
‚îÇ
‚îî‚îÄ‚îÄ tradeup/                       # Paquete principal de Python
    ‚îú‚îÄ‚îÄ __init__.py                # Inicializaci√≥n del paquete
    ‚îú‚îÄ‚îÄ cli.py                     # Interfaz de l√≠nea de comandos (tablas Rich)
    ‚îú‚îÄ‚îÄ contracts.py               # L√≥gica de negocio: validaci√≥n y c√°lculos
    ‚îú‚îÄ‚îÄ csfloat_api.py             # Cliente de CSFloat con reintentos/cach√©
    ‚îú‚îÄ‚îÄ csv_loader.py              # I/O de archivos: parseo y validaci√≥n CSV
    ‚îú‚îÄ‚îÄ models.py                  # Modelos de dominio y estructuras de datos
    ‚îú‚îÄ‚îÄ pricing.py                 # Obtenci√≥n y gesti√≥n de precios
    ‚îî‚îÄ‚îÄ __pycache__/               # Cach√© de bytecode de Python (gitignored)
```

## Capas de arquitectura

### 1. Capa de dominio (`models.py`)
**Prop√≥sito**: Entidades de negocio y value objects centrales
- `SkinCatalogItem`: Metadatos del skin (nombre, colecci√≥n, rareza, rango de float)
- `ContractEntry`: Entrada individual del contrato (skin + float + precio)
- `Outcome`: Resultado posible (skin + probabilidad + float esperado)
- `ContractResult`: An√°lisis completo (EV, ROI, outcomes, validaci√≥n)

**Principios de dise√±o**:
- Dataclasses inmutables con type hints
- Validaci√≥n de reglas de negocio al nivel del modelo
- Sin dependencias externas (l√≥gica de dominio pura)

### 2. Capa de aplicaci√≥n (`contracts.py`)
**Prop√≥sito**: Orquestar operaciones de negocio y c√°lculos
- Validaci√≥n del contrato (10 √≠tems, misma rareza, consistencia StatTrak)
- C√°lculo de float mediante promedio normalizado
- Distribuci√≥n de probabilidades mediante el modelo de "pool de outcomes"
- C√°lculo de valor esperado y ROI

**Funciones clave**:
- `validate_contract()`: Asegura cumplimiento de reglas de CS2
- `calculate_outcomes()`: Determina resultados posibles y probabilidades
- `calculate_contract_summary()`: Calcula EV, ROI y m√©tricas de riesgo

### 3. Capa de infraestructura
**Prop√≥sito**: Integraciones externas y persistencia de datos

#### Acceso a datos (`csv_loader.py`)
- Carga de cat√°logo con mapeo de encabezados ES/EN
- Parseo de CSVs de contrato con validaci√≥n
- Soporte de precios locales (m√∫ltiples formatos)
- Manejo de errores de datos malformados

#### APIs externas (`csfloat_api.py`)
- Integraci√≥n con marketplace CSFloat
- Reintentos con backoff exponencial
- Manejo de rate limit (HTTP 429)
- Cach√© JSON local para performance
- Construcci√≥n de `market_hash_name`

#### Precios (`pricing.py`)
- Resoluci√≥n multi‚Äëfuente (API vs CSV local)
- Inferencia de wear a partir del float
- Manejo de precios StatTrak‚Ñ¢
- Estrategias de fallback ante precios faltantes

### 4. Capa de interfaz (`cli.py`)
**Prop√≥sito**: Interacci√≥n con el usuario y formato de salida
- Parseo de argumentos con validaci√≥n
- Tablas con Rich para presentaci√≥n de resultados
- Mensajes de error en espa√±ol
- Indicadores de progreso para llamadas a API

## Flujo de datos

```
Archivos CSV ‚Üí csv_loader ‚Üí Modelos de dominio ‚Üí contracts.py ‚Üí L√≥gica de negocio
                                                 ‚Üì
CSFloat API ‚Üê csfloat_api ‚Üê pricing.py ‚Üê An√°lisis del contrato
                                                 ‚Üì
                                            cli.py ‚Üí Tablas Rich ‚Üí Consola
```

## Dependencias entre m√≥dulos

### Grafo de dependencias
```
cli.py
‚îú‚îÄ‚îÄ contracts.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îú‚îÄ‚îÄ csv_loader.py
‚îÇ   ‚îî‚îÄ‚îÄ pricing.py
‚îÇ       ‚îî‚îÄ‚îÄ csfloat_api.py
‚îî‚îÄ‚îÄ csv_loader.py
    ‚îî‚îÄ‚îÄ models.py
```

### Convenciones de importaci√≥n
- **Forward References**: `from __future__ import annotations`
- **Type‚Äëonly imports**: `from typing import TYPE_CHECKING`
- **Dependencias externas**: Importadas a nivel de m√≥dulo

## Gesti√≥n de configuraci√≥n

### Variables de entorno
```bash
# Requerida para integraci√≥n con CSFloat API
CSFLOAT_API_KEY=your_api_key_here

# Overrides opcionales
CSFLOAT_BASE=https://csfloat.com  # Base URL de la API
```

### Resoluci√≥n de rutas de archivos
1. Argumentos de CLI (mayor prioridad)
2. Directorio de trabajo actual
3. Ra√≠z del proyecto (fallback)
4. Valores por defecto

### Jerarqu√≠a de configuraci√≥n
```
CLI > Variables de entorno > Valores por defecto
```

## Convenciones de nombres y c√≥digo

### Nombres de archivos
- **M√≥dulos Python**: `snake_case.py`
- **Archivos CSV**: `nombre_descriptivo.csv`
- **Documentaci√≥n**: `tema.md`
- **Configuraci√≥n**: `.env`, `.gitignore`

### Estilo de c√≥digo
- **Clases**: `PascalCase` (ej.: `SkinCatalogItem`)
- **Funciones/variables**: `snake_case` (ej.: `calculate_outcomes`)
- **Constantes**: `UPPER_SNAKE_CASE` (ej.: `DEFAULT_FEES`)
- **Miembros privados**: `_leading_underscore`

### Anotaciones de tipo
```python
from __future__ import annotations
from typing import Optional, Dict, List, Union

def calculate_ev(outcomes: List[Outcome]) -> float:
    """Calcular el valor esperado con tipado completo."""
    return sum(outcome.price * outcome.probability for outcome in outcomes)
```

## Estrategia de manejo de errores

### Jerarqu√≠a de excepciones
```python
# Excepciones personalizadas para errores de dominio
class TradeUpError(Exception): pass
class ContractValidationError(TradeUpError): pass
class PricingError(TradeUpError): pass
class APIError(TradeUpError): pass
```

### Propagaci√≥n de errores
1. **Dominio**: Lanza excepciones espec√≠ficas de negocio
2. **Aplicaci√≥n**: Captura y enriquece con contexto
3. **Interfaz**: Traduce a mensajes claros para el usuario

## Estrategia de testing

### Organizaci√≥n de tests
```
tests/
‚îú‚îÄ‚îÄ unit/           # Tests unitarios aislados
‚îú‚îÄ‚îÄ integration/    # Tests de integraci√≥n multi‚Äëcomponente
‚îî‚îÄ‚îÄ fixtures/       # Datos de prueba y mocks
```

### Gesti√≥n de datos de prueba
- **Fixtures**: Contratos y cat√°logos reutilizables
- **Mocks**: Respuestas de CSFloat para tests determin√≠sticos
- **Property‚Äëbased**: Hypothesis para descubrir edge‚Äëcases

## Consideraciones de performance

### Estrategia de cach√©
- **Respuestas de API**: Cach√© JSON con TTL
- **Carga de cat√°logo**: Cach√© en memoria para accesos repetidos
- **B√∫squeda de precios**: Llamadas batch cuando sea posible

### Objetivos de optimizaci√≥n
- **Tiempo de respuesta CLI**: < 2 segundos para contratos t√≠picos
- **Uso de memoria**: < 100MB para cat√°logos grandes
- **Rate limits**: Respetar l√≠mites de CSFloat (60 req/min)

## Consideraciones de seguridad

### Gesti√≥n de API keys
- Variables de entorno (nunca hardcodear)
- `.env` gitignored
- Mensajes claros cuando falten claves

### Validaci√≥n de entradas
- Prevenci√≥n de inyecci√≥n CSV
- Validaci√≥n de rangos de floats
- Sanitizaci√≥n de rutas de archivos

## üîÆ Consideraciones Futuras de Arquitectura

### üîå Puntos de Extensibilidad Planificados

#### Sistema de Plugins para Fuentes de Precios
```python
# Interfaz para nuevos proveedores de precios
class PriceProvider(ABC):
    @abstractmethod
    def get_price(self, market_hash_name: str) -> Optional[int]:
        pass
    
    @abstractmethod
    def get_bulk_prices(self, items: List[str]) -> Dict[str, int]:
        pass

# Implementaciones espec√≠ficas
class CSFloatProvider(PriceProvider): pass
class SteamMarketProvider(PriceProvider): pass
class Buff163Provider(PriceProvider): pass
```

#### Modelos de Probabilidad Configurables
```python
class ProbabilityModel(ABC):
    @abstractmethod
    def calculate_probabilities(self, entries: List[ContractEntry], 
                              outcomes: List[Outcome]) -> Dict[str, float]:
        pass

class PoolOfOutcomesModel(ProbabilityModel): pass  # Actual
class ClassicUniformModel(ProbabilityModel): pass  # Futuro
class WeightedModel(ProbabilityModel): pass        # Futuro
```

#### Formatos de Salida Extensibles
- **JSON/XML**: Para integraciones program√°ticas
- **PDF Reports**: Para documentaci√≥n formal
- **Excel/CSV**: Para an√°lisis en hojas de c√°lculo
- **Database Export**: Para almacenamiento persistente

### üöÄ Preparaci√≥n para Escalabilidad

#### Migraci√≥n de Almacenamiento
```
Fase 1: CSV Files (Actual)
    ‚Üì
Fase 2: SQLite (Local, mejor performance)
    ‚Üì
Fase 3: PostgreSQL (Producci√≥n, multi-usuario)
    ‚Üì
Fase 4: Distributed DB (Alta escala)
```

#### Arquitectura de Microservicios
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Web Frontend  ‚îÇ    ‚îÇ   API Gateway   ‚îÇ    ‚îÇ  Auth Service   ‚îÇ
‚îÇ     (React)     ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ    (FastAPI)    ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   (JWT/OAuth)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ               ‚îÇ               ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   Pricing    ‚îÇ ‚îÇ  Contracts  ‚îÇ ‚îÇ  Catalog   ‚îÇ
        ‚îÇ   Service    ‚îÇ ‚îÇ   Service   ‚îÇ ‚îÇ  Service   ‚îÇ
        ‚îÇ  (CSFloat)   ‚îÇ ‚îÇ (Analysis)  ‚îÇ ‚îÇ  (Skins)   ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Procesamiento As√≠ncrono
```python
# Cola de trabajos para an√°lisis masivo
from celery import Celery

app = Celery('tradeup_analyzer')

@app.task
def analyze_contract_batch(contracts: List[Dict]) -> List[ContractResult]:
    """Procesar m√∫ltiples contratos en paralelo."""
    results = []
    for contract_data in contracts:
        result = analyze_single_contract(contract_data)
        results.append(result)
    return results

# Monitoreo en tiempo real
@app.task
def monitor_market_opportunities():
    """Buscar oportunidades de trade-up autom√°ticamente."""
    opportunities = scan_market_for_opportunities()
    if opportunities:
        send_notifications(opportunities)
```

### üåê Arquitectura Web Futura

#### Stack Tecnol√≥gico Propuesto
```
Frontend:
‚îú‚îÄ‚îÄ React 18+ (UI Framework)
‚îú‚îÄ‚îÄ TypeScript (Type Safety)
‚îú‚îÄ‚îÄ Tailwind CSS (Styling)
‚îú‚îÄ‚îÄ React Query (State Management)
‚îî‚îÄ‚îÄ Vite (Build Tool)

Backend:
‚îú‚îÄ‚îÄ FastAPI (Python Web Framework)
‚îú‚îÄ‚îÄ Pydantic (Data Validation)
‚îú‚îÄ‚îÄ SQLAlchemy (ORM)
‚îú‚îÄ‚îÄ Redis (Caching)
‚îî‚îÄ‚îÄ Celery (Background Tasks)

Infrastructure:
‚îú‚îÄ‚îÄ Docker (Containerization)
‚îú‚îÄ‚îÄ PostgreSQL (Database)
‚îú‚îÄ‚îÄ Nginx (Reverse Proxy)
‚îî‚îÄ‚îÄ GitHub Actions (CI/CD)
```

#### Flujo de Datos Web
```
User Input ‚Üí React Form ‚Üí API Request ‚Üí FastAPI ‚Üí Business Logic ‚Üí Database
    ‚Üë                                                    ‚Üì
User Interface ‚Üê JSON Response ‚Üê API Response ‚Üê Contract Analysis ‚Üê Data Layer
```

### üì± Consideraciones Mobile

#### Progressive Web App (PWA)
- **Offline Capability**: Cach√© de cat√°logos y an√°lisis previos
- **Push Notifications**: Alertas de oportunidades de mercado
- **Responsive Design**: Optimizado para m√≥viles y tablets

#### Native Apps (Futuro)
- **React Native**: Compartir l√≥gica con web
- **Flutter**: Performance nativa multiplataforma
- **Integraci√≥n Steam**: Acceso directo al inventario

### üîê Consideraciones de Seguridad Avanzadas

#### Autenticaci√≥n y Autorizaci√≥n
```python
# JWT-based authentication
class AuthService:
    def authenticate_user(self, credentials: UserCredentials) -> Optional[User]:
        pass
    
    def generate_token(self, user: User) -> str:
        pass
    
    def validate_token(self, token: str) -> Optional[User]:
        pass

# Role-based access control
class Permission(Enum):
    READ_CONTRACTS = "read:contracts"
    WRITE_CONTRACTS = "write:contracts"
    ADMIN_USERS = "admin:users"
```

#### Protecci√≥n de APIs
- **Rate Limiting**: Por usuario y por IP
- **Input Validation**: Sanitizaci√≥n de todos los inputs
- **CORS Policy**: Configuraci√≥n restrictiva para producci√≥n
- **API Versioning**: Versionado sem√°ntico para compatibilidad

### üìä Monitoreo y Observabilidad

#### M√©tricas de Sistema
```python
# Prometheus metrics
from prometheus_client import Counter, Histogram, Gauge

contract_analyses = Counter('contract_analyses_total', 'Total contract analyses')
analysis_duration = Histogram('analysis_duration_seconds', 'Analysis duration')
active_users = Gauge('active_users', 'Currently active users')
```

#### Logging Estructurado
```python
import structlog

logger = structlog.get_logger()

def analyze_contract(contract_data: dict):
    logger.info("Starting contract analysis", 
                contract_id=contract_data.get('id'),
                user_id=get_current_user().id,
                entry_count=len(contract_data.get('entries', [])))
```

### üß™ Testing Strategy Avanzada

#### Tipos de Testing
```
Unit Tests (90%+ coverage)
‚îú‚îÄ‚îÄ Domain Logic Tests
‚îú‚îÄ‚îÄ API Integration Tests
‚îî‚îÄ‚îÄ Utility Function Tests

Integration Tests
‚îú‚îÄ‚îÄ Database Integration
‚îú‚îÄ‚îÄ External API Integration
‚îî‚îÄ‚îÄ End-to-End Workflows

Performance Tests
‚îú‚îÄ‚îÄ Load Testing (Artillery/k6)
‚îú‚îÄ‚îÄ Stress Testing
‚îî‚îÄ‚îÄ Memory Profiling

Security Tests
‚îú‚îÄ‚îÄ OWASP ZAP Scanning
‚îú‚îÄ‚îÄ Dependency Vulnerability Scanning
‚îî‚îÄ‚îÄ Penetration Testing
```

Esta arquitectura evolutiva permite que TradeUpSPY crezca desde una herramienta CLI simple hasta una plataforma completa de an√°lisis de trading, manteniendo siempre la calidad, performance y seguridad del sistema.